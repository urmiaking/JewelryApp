@page "/settings"
@inherits UserComponentBase

@inject ISnackbar Snackbar

<MudGrid>

    <MudItem xs="12" sm="6">
        <MudGrid>
            <MudItem xs="12">
                <EditForm Model="@PasswordModel" OnValidSubmit="OnPasswordChangeSubmit">
                    <DataAnnotationsValidator />
                    <MudCard>
                        <MudCardContent>
                            <MudTextField Label="رمز عبور فعلی" HelperText="رمز عبور فعلی خود را وارد کنید" InputType="InputType.Password"
                                          @bind-Value="PasswordModel.OldPassword" For="@(() => PasswordModel.OldPassword)" />
                            <MudTextField Label="رمز عبور جدید" HelperText="رمز عبور جدید خود را وارد کنید" InputType="InputType.Password"
                                          @bind-Value="PasswordModel.NewPassword" For="@(() => PasswordModel.NewPassword)" />
                            <MudTextField Label="تکرار رمز عبور جدید" HelperText="تکرار رمز عبور جدید خود را وارد کنید" InputType="InputType.Password"
                                          @bind-Value="PasswordModel.ConfirmPassword" For="@(() => PasswordModel.ConfirmPassword)" />
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">ذخیره</MudButton>
                        </MudCardActions>
                    </MudCard>
                </EditForm>
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>

@code {
    MudListItem selectedItem;
    object selectedValue = 1;
    Color _color = Color.Success;

    [Parameter]
    public ChangePasswordDto PasswordModel { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }
    
    async Task OnPasswordChangeSubmit()
    {
        var httpResponseMessage = await AuthorizedHttpClient.PutAsJsonAsync("/changepassword", PasswordModel);

        if (httpResponseMessage.IsSuccessStatusCode)
        {
            Snackbar.Add("رمز عبور با موفقیت تغییر داده شد! لطفا مجددا با رمز جدید خود وارد شوید", Severity.Success);
            NavigationManager.NavigateTo("/logout");
        }
        else
        {
            Snackbar.Add("تغییر رمز عبور با خطا مواجه شد! لطفا رمز خود را چک کنید", Severity.Error);
        }
    }
}